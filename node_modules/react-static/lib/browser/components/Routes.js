"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _react = _interopRequireWildcard(require("react"));

var _2 = require("..");

var _utils = require("../utils");

var _useStaticInfo = require("../hooks/useStaticInfo");

var _useRoutePath = require("../hooks/useRoutePath");

//

/**
 *
 * @param {string} path
 * @returns {React.ComponentType<{}> | false}
 */
function getTemplateForPath(path) {
  var is404 = (0, _utils.is404Path)(path);
  var Comp = _2.templatesByPath[path] || false;

  if (!Comp && _2.templateErrorByPath[path]) {
    is404 = true;
    Comp = _2.templatesByPath[_utils.PATH_404] || false;
  }

  return {
    is404: is404,
    Comp: Comp
  };
}
/**
 *
 *
 * @param {string} path
 * @returns {React.ReactNode | false}
 */


function getComponentForPath(path) {
  var _getTemplateForPath = getTemplateForPath(path),
      Comp = _getTemplateForPath.Comp,
      is404 = _getTemplateForPath.is404;

  if (is404 || !Comp) {
    return false;
  }

  return _react["default"].createElement(Comp, {
    is404: is404
  });
}

var RoutesInner = function RoutesInner(_ref) {
  var routePath = _ref.routePath,
      renderFn = _ref.render;
  // Let the user specify a manual routePath.
  // This is useful for animations where multiple routes
  // might be rendered simultaneously
  var staticInfo = (0, _useStaticInfo.useStaticInfo)(); // eslint-disable-next-line

  var _useState = (0, _react.useState)(0),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      _ = _useState2[0],
      setCount = _useState2[1]; // If in production, make sure the staticInfo is ingested into the
  // cache


  (0, _react.useState)(function () {
    // useState's initializer will only fire once per component instance,
    // and it will fire during the first render (unlike an effect, which
    // only fires after the first render). Think of it like a constructor call.
    if (process.env.REACT_STATIC_ENV === 'production' && staticInfo) {
      var path = staticInfo.path,
          sharedData = staticInfo.sharedData,
          sharedHashesByProp = staticInfo.sharedHashesByProp,
          template = staticInfo.template; // Hydrate routeInfoByPath with the embedded routeInfo

      _2.routeInfoByPath[path] = staticInfo; // Hydrate sharedDataByHash with the embedded routeInfo

      Object.keys(sharedHashesByProp).forEach(function (propKey) {
        _2.sharedDataByHash[sharedHashesByProp[propKey]] = sharedData[propKey];
      }); // In SRR and production, synchronously register the template for the
      // initial path

      (0, _2.registerTemplateForPath)(path, template); // For a 404 route we will register the current route as invalid

      if ((0, _utils.is404Path)(path)) {
        var currentPath = (0, _utils.getCurrentRoutePath)(); // As long as we didn't navigate to the 404.html page directly

        if ((0, _utils.is404Path)(currentPath)) {
          _2.routeErrorByPath[currentPath] = true;
          _2.templateErrorByPath[currentPath] = true;
        }
      }
    }
  });
  (0, _react.useEffect)(function () {
    return (0, _2.onReloadTemplates)(function () {
      setCount(function (old) {
        return old + 1;
      });
    });
  }); // If SSR, force the routePath to be the statically exported one

  if (typeof document === 'undefined') {
    routePath = staticInfo.path;
  } else if (!routePath) {
    // If a routePath is still not defined in the browser,
    // use the window location as the default
    routePath = decodeURIComponent(window.location.href);
  }

  routePath = (0, _useRoutePath.useRoutePath)(routePath); // Try and get the template

  var _getTemplateForPath2 = getTemplateForPath(routePath),
      Comp = _getTemplateForPath2.Comp,
      is404 = _getTemplateForPath2.is404;

  if (!Comp) {
    if (is404) {
      throw new Error('Neither the page template or 404 template could be found. This means something is terribly wrong. Please, file an issue!');
    } // Suspend while we fetch the resource


    throw Promise.all([new Promise(function (resolve) {
      return setTimeout(resolve, 500);
    }), (0, _2.prefetch)(routePath, {
      priority: true
    })]);
  }

  return _react["default"].createElement(_useRoutePath.routePathContext.Provider, {
    value: routePath
  }, renderFn ? renderFn({
    routePath: routePath,
    getComponentForPath: getComponentForPath
  }) : _react["default"].createElement(Comp, {
    is404: is404
  }));
};

var Routes = function Routes(_ref2) {
  var originalProps = (0, _extends2["default"])({}, _ref2);
  // Once a routePath goes into the Routes component,
  // useRoutePath must ALWAYS return the routePath used
  // in its parent, so we pass it down as context
  // Get the Routes hook
  var CompWrapper = (0, _react.useMemo)(function () {
    return _2.plugins.Routes(function (props) {
      return _react["default"].createElement(RoutesInner, props);
    });
  }, [_2.plugins]); // Pass all props so that plugins can use it

  return _react["default"].createElement(CompWrapper, originalProps);
};

var _default = Routes;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL2NvbXBvbmVudHMvUm91dGVzLmpzIl0sIm5hbWVzIjpbImdldFRlbXBsYXRlRm9yUGF0aCIsInBhdGgiLCJpczQwNCIsIkNvbXAiLCJ0ZW1wbGF0ZXNCeVBhdGgiLCJ0ZW1wbGF0ZUVycm9yQnlQYXRoIiwiUEFUSF80MDQiLCJnZXRDb21wb25lbnRGb3JQYXRoIiwiUmVhY3QiLCJjcmVhdGVFbGVtZW50IiwiUm91dGVzSW5uZXIiLCJyb3V0ZVBhdGgiLCJyZW5kZXJGbiIsInJlbmRlciIsInN0YXRpY0luZm8iLCJfIiwic2V0Q291bnQiLCJwcm9jZXNzIiwiZW52IiwiUkVBQ1RfU1RBVElDX0VOViIsInNoYXJlZERhdGEiLCJzaGFyZWRIYXNoZXNCeVByb3AiLCJ0ZW1wbGF0ZSIsInJvdXRlSW5mb0J5UGF0aCIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwicHJvcEtleSIsInNoYXJlZERhdGFCeUhhc2giLCJjdXJyZW50UGF0aCIsInJvdXRlRXJyb3JCeVBhdGgiLCJvbGQiLCJkb2N1bWVudCIsImRlY29kZVVSSUNvbXBvbmVudCIsIndpbmRvdyIsImxvY2F0aW9uIiwiaHJlZiIsIkVycm9yIiwiUHJvbWlzZSIsImFsbCIsInJlc29sdmUiLCJzZXRUaW1lb3V0IiwicHJpb3JpdHkiLCJSb3V0ZXMiLCJvcmlnaW5hbFByb3BzIiwiQ29tcFdyYXBwZXIiLCJwbHVnaW5zIiwicHJvcHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBOztBQVdBOztBQUNBOztBQUNBOztBQWRBOztBQWdCQTs7Ozs7QUFLQSxTQUFTQSxrQkFBVCxDQUE0QkMsSUFBNUIsRUFBa0M7QUFDaEMsTUFBSUMsS0FBSyxHQUFHLHNCQUFVRCxJQUFWLENBQVo7QUFDQSxNQUFJRSxJQUFJLEdBQUdDLG1CQUFnQkgsSUFBaEIsS0FBeUIsS0FBcEM7O0FBRUEsTUFBSSxDQUFDRSxJQUFELElBQVNFLHVCQUFvQkosSUFBcEIsQ0FB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LENBQU47QUFBQSxHQURrQixFQUVsQixDQUFDRCxVQUFELENBRmtCLENBQXBCLENBTnVDLENBV3ZDOztBQUNBLFNBQU8sZ0NBQUMsV0FBRCxFQUFpQkYsYUFBakIsQ0FBUDtBQUNELENBYkQ7O2VBZWVELE0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgdXNlU3RhdGUsIHVzZU1lbW8sIHVzZUVmZmVjdCB9IGZyb20gJ3JlYWN0J1xuLy9cbmltcG9ydCB7XG4gIHRlbXBsYXRlc0J5UGF0aCxcbiAgdGVtcGxhdGVFcnJvckJ5UGF0aCxcbiAgcm91dGVJbmZvQnlQYXRoLFxuICBzaGFyZWREYXRhQnlIYXNoLFxuICByZWdpc3RlclRlbXBsYXRlRm9yUGF0aCxcbiAgcHJlZmV0Y2gsXG4gIHBsdWdpbnMsXG4gIG9uUmVsb2FkVGVtcGxhdGVzLFxuICByb3V0ZUVycm9yQnlQYXRoLFxufSBmcm9tICcuLidcbmltcG9ydCB7IGdldEN1cnJlbnRSb3V0ZVBhdGgsIGlzNDA0UGF0aCwgUEFUSF80MDQgfSBmcm9tICcuLi91dGlscydcbmltcG9ydCB7IHVzZVN0YXRpY0luZm8gfSBmcm9tICcuLi9ob29rcy91c2VTdGF0aWNJbmZvJ1xuaW1wb3J0IHsgcm91dGVQYXRoQ29udGV4dCwgdXNlUm91dGVQYXRoIH0gZnJvbSAnLi4vaG9va3MvdXNlUm91dGVQYXRoJ1xuXG4vKipcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcGF0aFxuICogQHJldHVybnMge1JlYWN0LkNvbXBvbmVudFR5cGU8e30+IHwgZmFsc2V9XG4gKi9cbmZ1bmN0aW9uIGdldFRlbXBsYXRlRm9yUGF0aChwYXRoKSB7XG4gIGxldCBpczQwNCA9IGlzNDA0UGF0aChwYXRoKVxuICBsZXQgQ29tcCA9IHRlbXBsYXRlc0J5UGF0aFtwYXRoXSB8fCBmYWxzZVxuXG4gIGlmICghQ29tcCAmJiB0ZW1wbGF0ZUVycm9yQnlQYXRoW3BhdGhdKSB7XG4gICAgaXM0MDQgPSB0cnVlXG4gICAgQ29tcCA9IHRlbXBsYXRlc0J5UGF0aFtQQVRIXzQwNF0gfHwgZmFsc2VcbiAgfVxuXG4gIHJldHVybiB7IGlzNDA0LCBDb21wIH1cbn1cblxuLyoqXG4gKlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoXG4gKiBAcmV0dXJucyB7UmVhY3QuUmVhY3ROb2RlIHwgZmFsc2V9XG4gKi9cbmZ1bmN0aW9uIGdldENvbXBvbmVudEZvclBhdGgocGF0aCkge1xuICBjb25zdCB7IENvbXAsIGlzNDA0IH0gPSBnZXRUZW1wbGF0ZUZvclBhdGgocGF0aClcbiAgaWYgKGlzNDA0IHx8ICFDb21wKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChDb21wLCB7IGlzNDA0IH0pXG59XG5cbmNvbnN0IFJvdXRlc0lubmVyID0gKHsgcm91dGVQYXRoLCByZW5kZXI6IHJlbmRlckZuIH0pID0+IHtcbiAgLy8gTGV0IHRoZSB1c2VyIHNwZWNpZnkgYSBtYW51YWwgcm91dGVQYXRoLlxuICAvLyBUaGlzIGlzIHVzZWZ1bCBmb3IgYW5pbWF0aW9ucyB3aGVyZSBtdWx0aXBsZSByb3V0ZXNcbiAgLy8gbWlnaHQgYmUgcmVuZGVyZWQgc2ltdWx0YW5lb3VzbHlcblxuICBjb25zdCBzdGF0aWNJbmZvID0gdXNlU3RhdGljSW5mbygpXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICBjb25zdCBbXywgc2V0Q291bnRdID0gdXNlU3RhdGUoMClcblxuICAvLyBJZiBpbiBwcm9kdWN0aW9uLCBtYWtlIHN1cmUgdGhlIHN0YXRpY0luZm8gaXMgaW5nZXN0ZWQgaW50byB0aGVcbiAgLy8gY2FjaGVcbiAgdXNlU3RhdGUoKCkgPT4ge1xuICAgIC8vIHVzZVN0YXRlJ3MgaW5pdGlhbGl6ZXIgd2lsbCBvbmx5IGZpcmUgb25jZSBwZXIgY29tcG9uZW50IGluc3RhbmNlLFxuICAgIC8vIGFuZCBpdCB3aWxsIGZpcmUgZHVyaW5nIHRoZSBmaXJzdCByZW5kZXIgKHVubGlrZSBhbiBlZmZlY3QsIHdoaWNoXG4gICAgLy8gb25seSBmaXJlcyBhZnRlciB0aGUgZmlyc3QgcmVuZGVyKS4gVGhpbmsgb2YgaXQgbGlrZSBhIGNvbnN0cnVjdG9yIGNhbGwuXG4gICAgaWYgKHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19FTlYgPT09ICdwcm9kdWN0aW9uJyAmJiBzdGF0aWNJbmZvKSB7XG4gICAgICBjb25zdCB7IHBhdGgsIHNoYXJlZERhdGEsIHNoYXJlZEhhc2hlc0J5UHJvcCwgdGVtcGxhdGUgfSA9IHN0YXRpY0luZm9cblxuICAgICAgLy8gSHlkcmF0ZSByb3V0ZUluZm9CeVBhdGggd2l0aCB0aGUgZW1iZWRkZWQgcm91dGVJbmZvXG4gICAgICByb3V0ZUluZm9CeVBhdGhbcGF0aF0gPSBzdGF0aWNJbmZvXG5cbiAgICAgIC8vIEh5ZHJhdGUgc2hhcmVkRGF0YUJ5SGFzaCB3aXRoIHRoZSBlbWJlZGRlZCByb3V0ZUluZm9cbiAgICAgIE9iamVjdC5rZXlzKHNoYXJlZEhhc2hlc0J5UHJvcCkuZm9yRWFjaChwcm9wS2V5ID0+IHtcbiAgICAgICAgc2hhcmVkRGF0YUJ5SGFzaFtzaGFyZWRIYXNoZXNCeVByb3BbcHJvcEtleV1dID0gc2hhcmVkRGF0YVtwcm9wS2V5XVxuICAgICAgfSlcblxuICAgICAgLy8gSW4gU1JSIGFuZCBwcm9kdWN0aW9uLCBzeW5jaHJvbm91c2x5IHJlZ2lzdGVyIHRoZSB0ZW1wbGF0ZSBmb3IgdGhlXG4gICAgICAvLyBpbml0aWFsIHBhdGhcbiAgICAgIHJlZ2lzdGVyVGVtcGxhdGVGb3JQYXRoKHBhdGgsIHRlbXBsYXRlKVxuXG4gICAgICAvLyBGb3IgYSA0MDQgcm91dGUgd2Ugd2lsbCByZWdpc3RlciB0aGUgY3VycmVudCByb3V0ZSBhcyBpbnZhbGlkXG4gICAgICBpZiAoaXM0MDRQYXRoKHBhdGgpKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRQYXRoID0gZ2V0Q3VycmVudFJvdXRlUGF0aCgpXG4gICAgICAgIC8vIEFzIGxvbmcgYXMgd2UgZGlkbid0IG5hdmlnYXRlIHRvIHRoZSA0MDQuaHRtbCBwYWdlIGRpcmVjdGx5XG4gICAgICAgIGlmIChpczQwNFBhdGgoY3VycmVudFBhdGgpKSB7XG4gICAgICAgICAgcm91dGVFcnJvckJ5UGF0aFtjdXJyZW50UGF0aF0gPSB0cnVlXG4gICAgICAgICAgdGVtcGxhdGVFcnJvckJ5UGF0aFtjdXJyZW50UGF0aF0gPSB0cnVlXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0pXG5cbiAgdXNlRWZmZWN0KCgpID0+XG4gICAgb25SZWxvYWRUZW1wbGF0ZXMoKCkgPT4ge1xuICAgICAgc2V0Q291bnQob2xkID0+IG9sZCArIDEpXG4gICAgfSlcbiAgKVxuXG4gIC8vIElmIFNTUiwgZm9yY2UgdGhlIHJvdXRlUGF0aCB0byBiZSB0aGUgc3RhdGljYWxseSBleHBvcnRlZCBvbmVcbiAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICByb3V0ZVBhdGggPSBzdGF0aWNJbmZvLnBhdGhcbiAgfSBlbHNlIGlmICghcm91dGVQYXRoKSB7XG4gICAgLy8gSWYgYSByb3V0ZVBhdGggaXMgc3RpbGwgbm90IGRlZmluZWQgaW4gdGhlIGJyb3dzZXIsXG4gICAgLy8gdXNlIHRoZSB3aW5kb3cgbG9jYXRpb24gYXMgdGhlIGRlZmF1bHRcbiAgICByb3V0ZVBhdGggPSBkZWNvZGVVUklDb21wb25lbnQod2luZG93LmxvY2F0aW9uLmhyZWYpXG4gIH1cblxuICByb3V0ZVBhdGggPSB1c2VSb3V0ZVBhdGgocm91dGVQYXRoKVxuXG4gIC8vIFRyeSBhbmQgZ2V0IHRoZSB0ZW1wbGF0ZVxuICBjb25zdCB7IENvbXAsIGlzNDA0IH0gPSBnZXRUZW1wbGF0ZUZvclBhdGgocm91dGVQYXRoKVxuXG4gIGlmICghQ29tcCkge1xuICAgIGlmIChpczQwNCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnTmVpdGhlciB0aGUgcGFnZSB0ZW1wbGF0ZSBvciA0MDQgdGVtcGxhdGUgY291bGQgYmUgZm91bmQuIFRoaXMgbWVhbnMgc29tZXRoaW5nIGlzIHRlcnJpYmx5IHdyb25nLiBQbGVhc2UsIGZpbGUgYW4gaXNzdWUhJ1xuICAgICAgKVxuICAgIH1cbiAgICAvLyBTdXNwZW5kIHdoaWxlIHdlIGZldGNoIHRoZSByZXNvdXJjZVxuICAgIHRocm93IFByb21pc2UuYWxsKFtcbiAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MDApKSxcbiAgICAgIHByZWZldGNoKHJvdXRlUGF0aCwgeyBwcmlvcml0eTogdHJ1ZSB9KSxcbiAgICBdKVxuICB9XG5cbiAgcmV0dXJuIChcbiAgICA8cm91dGVQYXRoQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17cm91dGVQYXRofT5cbiAgICAgIHtyZW5kZXJGbiA/IChcbiAgICAgICAgcmVuZGVyRm4oeyByb3V0ZVBhdGgsIGdldENvbXBvbmVudEZvclBhdGggfSlcbiAgICAgICkgOiAoXG4gICAgICAgIDxDb21wIGlzNDA0PXtpczQwNH0gLz5cbiAgICAgICl9XG4gICAgPC9yb3V0ZVBhdGhDb250ZXh0LlByb3ZpZGVyPlxuICApXG59XG5cbmNvbnN0IFJvdXRlcyA9ICh7IC4uLm9yaWdpbmFsUHJvcHMgfSkgPT4ge1xuICAvLyBPbmNlIGEgcm91dGVQYXRoIGdvZXMgaW50byB0aGUgUm91dGVzIGNvbXBvbmVudCxcbiAgLy8gdXNlUm91dGVQYXRoIG11c3QgQUxXQVlTIHJldHVybiB0aGUgcm91dGVQYXRoIHVzZWRcbiAgLy8gaW4gaXRzIHBhcmVudCwgc28gd2UgcGFzcyBpdCBkb3duIGFzIGNvbnRleHRcblxuICAvLyBHZXQgdGhlIFJvdXRlcyBob29rXG4gIGNvbnN0IENvbXBXcmFwcGVyID0gdXNlTWVtbyhcbiAgICAoKSA9PiBwbHVnaW5zLlJvdXRlcyhwcm9wcyA9PiA8Um91dGVzSW5uZXIgey4uLnByb3BzfSAvPiksXG4gICAgW3BsdWdpbnNdXG4gIClcblxuICAvLyBQYXNzIGFsbCBwcm9wcyBzbyB0aGF0IHBsdWdpbnMgY2FuIHVzZSBpdFxuICByZXR1cm4gPENvbXBXcmFwcGVyIHsuLi5vcmlnaW5hbFByb3BzfSAvPlxufVxuXG5leHBvcnQgZGVmYXVsdCBSb3V0ZXNcbiJdfQ==