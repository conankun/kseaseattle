"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getEmbeddedRouteInfoScript = getEmbeddedRouteInfoScript;
exports["default"] = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _crypto = _interopRequireDefault(require("crypto"));

var _react = _interopRequireDefault(require("react"));

var _server = require("react-dom/server");

var _reactHelmet = _interopRequireDefault(require("react-helmet"));

var _reactUniversalComponent = require("react-universal-component");

var _webpackFlushChunks = _interopRequireDefault(require("webpack-flush-chunks"));

var _path = _interopRequireDefault(require("path"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _jsesc = _interopRequireDefault(require("jsesc"));

var _Redirect = _interopRequireDefault(require("./components/Redirect"));

var _plugins = _interopRequireDefault(require("./plugins"));

var _utils = require("../utils");

var _chunkBuilder = require("../utils/chunkBuilder");

var _HtmlWithMeta = _interopRequireDefault(require("./components/HtmlWithMeta"));

var _HeadWithMeta = _interopRequireDefault(require("./components/HeadWithMeta"));

var _BodyWithMeta = _interopRequireDefault(require("./components/BodyWithMeta"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var cachedBasePath;
var cachedHrefReplace;
var cachedSrcReplace;

function getSHA256(str) {
  var hash = _crypto["default"].createHash('sha256');

  hash.update(str);
  return hash.digest('base64');
}

function getSubresourceHash(str) {
  var sha256 = getSHA256(str);
  return "sha256-".concat(sha256);
}

function getEmbeddedRouteInfoScript(embeddedRouteInfo) {
  var routeInfoJSON = (0, _jsesc["default"])(JSON.stringify(embeddedRouteInfo), {
    isScriptContext: true,
    wrap: true,
    json: true
  });
  var script = "window.__routeInfo = JSON.parse(".concat(routeInfoJSON, ");");
  var hash = getSubresourceHash(script);
  return {
    hash: hash,
    script: script
  };
}

var _default =
/*#__PURE__*/
function () {
  var _exportRoute = (0, _asyncToGenerator2["default"])(
  /*#__PURE__*/
  _regenerator["default"].mark(function _callee(state) {
    var _state, config, DocumentTemplate, route, siteData, clientStats, incremental, _state2, Comp, sharedHashesByProp, template, data, sharedData, routePath, remove, removeLocation, basePath, hrefReplace, srcReplace, routeInfo, embeddedRouteInfo, inlineScripts, meta, chunkNames, head, clientScripts, clientStyleSheets, clientCss, FinalComp, renderToStringAndExtract, appHtml, RenderedComp, DocumentHtml, html, publicPath, htmlFilename, routeInfoFilename, res;

    return _regenerator["default"].wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            _state = state, config = _state.config, DocumentTemplate = _state.DocumentTemplate, route = _state.route, siteData = _state.siteData, clientStats = _state.clientStats, incremental = _state.incremental;
            _state2 = state, Comp = _state2.Comp;
            sharedHashesByProp = route.sharedHashesByProp, template = route.template, data = route.data, sharedData = route.sharedData, routePath = route.path, remove = route.remove;

            if (!(incremental && remove)) {
              _context.next = 8;
              break;
            }

            if (!((0, _utils.is404Path)(route.path) || route.path === '/')) {
              _context.next = 6;
              break;
            }

            throw new Error("You are attempting to incrementally remove the ".concat((0, _utils.is404Path)(route.path) ? '404' : 'index', " route from your export. This is currently not supported (or recommended) by React Static."));

          case 6:
            removeLocation = _path["default"].join(config.paths.DIST, route.path);
            return _context.abrupt("return", _fsExtra["default"].remove(removeLocation));

          case 8:
            basePath = cachedBasePath || (cachedBasePath = config.basePath);
            hrefReplace = cachedHrefReplace || (cachedHrefReplace = new RegExp("(href=[\"'])\\/(".concat(basePath ? "".concat(basePath, "\\/") : '', ")?([^\\/])"), 'gm'));
            srcReplace = cachedSrcReplace || (cachedSrcReplace = new RegExp("(src=[\"'])\\/(".concat(basePath ? "".concat(basePath, "\\/") : '', ")?([^\\/])"), 'gm')); // This routeInfo will be saved to disk. It should only include the
            // data and hashes to construct all of the props later.

            routeInfo = {
              template: template,
              sharedHashesByProp: sharedHashesByProp,
              data: data,
              path: routePath // This embeddedRouteInfo will be inlined into the HTML for this route.
              // It should include all of the data, including shared data

            };
            embeddedRouteInfo = _objectSpread({}, routeInfo, {
              sharedData: sharedData,
              siteData: siteData
            });
            inlineScripts = {
              routeInfo: getEmbeddedRouteInfoScript(embeddedRouteInfo)
            };
            state = _objectSpread({}, state, {
              routeInfo: routeInfo,
              embeddedRouteInfo: embeddedRouteInfo,
              inlineScripts: inlineScripts // Make a place to collect chunks, meta info and head tags

            });
            meta = {};
            chunkNames = [];
            head = {};
            clientScripts = [];
            clientStyleSheets = [];
            clientCss = {};
            // Get the react component from the Comp and pass it the export context. This
            // uses reactContext under the hood to pass down the exportContext, since
            // react's new context api doesn't survive across bundling.
            Comp = config.disableRuntime ? Comp : Comp(embeddedRouteInfo);

            if (route.redirect) {
              FinalComp = function FinalComp() {
                return _react["default"].createElement(_Redirect["default"], {
                  fromPath: route.path,
                  to: route.redirect
                });
              };
            } else {
              FinalComp = function FinalComp(props) {
                return _react["default"].createElement(_reactUniversalComponent.ReportChunks, {
                  report: function report(chunkName) {
                    // if we are building to a absolute path we must make the detected
                    // chunkName relative and matching to the one we set in
                    // generateTemplates
                    if (!config.paths.DIST.startsWith(config.paths.ROOT)) {
                      chunkName = (0, _chunkBuilder.absoluteToRelativeChunkName)(config.paths.ROOT, chunkName);
                    }

                    chunkNames.push(chunkName);
                  }
                }, _react["default"].createElement(Comp, props));
              };
            }

            renderToStringAndExtract = function renderToStringAndExtract(comp) {
              // Rend the app to string!
              var appHtml = (0, _server.renderToString)(comp);

              var _flushChunks = (0, _webpackFlushChunks["default"])(clientStats, {
                chunkNames: chunkNames,
                outputPath: config.paths.DIST
              }),
                  scripts = _flushChunks.scripts,
                  stylesheets = _flushChunks.stylesheets,
                  css = _flushChunks.css;

              clientScripts = scripts;
              clientStyleSheets = stylesheets;
              clientCss = css; // Extract head calls using Helmet synchronously right after renderToString
              // to not introduce any race conditions in the meta data rendering

              var helmet = _reactHelmet["default"].renderStatic();

              head = {
                htmlProps: helmet.htmlAttributes.toComponent(),
                bodyProps: helmet.bodyAttributes.toComponent(),
                base: helmet.base.toComponent(),
                link: helmet.link.toComponent(),
                meta: helmet.meta.toComponent(),
                noscript: helmet.noscript.toComponent(),
                script: helmet.script.toComponent(),
                style: helmet.style.toComponent(),
                title: helmet.title.toComponent()
              };
              return appHtml;
            };

            state = _objectSpread({}, state, {
              meta: meta
            });
            _context.prev = 25;
            _context.next = 28;
            return _plugins["default"].beforeRenderToElement(FinalComp, state);

          case 28:
            FinalComp = _context.sent;

            if (!config.renderToElement) {
              _context.next = 31;
              break;
            }

            throw new Error("config.renderToElement has been deprecated in favor of the " + "'beforeRenderToElement' or 'beforeRenderToHtml' hooks instead.");

          case 31:
            RenderedComp = _react["default"].createElement(FinalComp, null); // Run the beforeRenderToHtml hook
            // Rum the Html hook

            _context.next = 34;
            return _plugins["default"].beforeRenderToHtml(RenderedComp, state);

          case 34:
            RenderedComp = _context.sent;

            if (!config.renderToHtml) {
              _context.next = 37;
              break;
            }

            throw new Error("config.renderToHtml has been deprecated in favor of the " + "'beforeRenderToHtml' or 'beforeHtmlToDocument' hooks instead.");

          case 37:
            appHtml = renderToStringAndExtract(RenderedComp);
            _context.next = 40;
            return _plugins["default"].beforeHtmlToDocument(appHtml, state);

          case 40:
            appHtml = _context.sent;
            _context.next = 48;
            break;

          case 43:
            _context.prev = 43;
            _context.t0 = _context["catch"](25);

            if (_context.t0.then) {
              _context.t0.message = 'Components are not allowed to suspend during static export. Please ' + 'make its data available synchronously and try again!';
            }

            _context.t0.message = "Failed exporting HTML for URL ".concat(route.path, " (").concat(route.template, "): ").concat(_context.t0.message);
            throw _context.t0;

          case 48:
            state = _objectSpread({}, state, {
              head: head,
              clientScripts: clientScripts,
              clientStyleSheets: clientStyleSheets,
              clientCss: clientCss
            });
            _context.t1 = _server.renderToStaticMarkup;
            _context.t2 = _react["default"];
            _context.t3 = DocumentTemplate;
            _context.next = 54;
            return (0, _HtmlWithMeta["default"])(state);

          case 54:
            _context.t4 = _context.sent;
            _context.next = 57;
            return (0, _HeadWithMeta["default"])(state);

          case 57:
            _context.t5 = _context.sent;
            _context.next = 60;
            return (0, _BodyWithMeta["default"])(state);

          case 60:
            _context.t6 = _context.sent;
            _context.t7 = state;
            _context.t8 = {
              Html: _context.t4,
              Head: _context.t5,
              Body: _context.t6,
              state: _context.t7
            };
            _context.t9 = _react["default"].createElement("div", {
              id: "root",
              dangerouslySetInnerHTML: {
                __html: appHtml
              }
            });
            _context.t10 = _context.t2.createElement.call(_context.t2, _context.t3, _context.t8, _context.t9);
            DocumentHtml = (0, _context.t1)(_context.t10);
            // Render the html for the page inside of the base document.
            html = "<!DOCTYPE html>".concat(DocumentHtml);
            _context.next = 69;
            return _plugins["default"].beforeDocumentToFile(html, state);

          case 69:
            html = _context.sent;
            // If the siteRoot is set and we're not in staging, prefix all absolute URLs
            // with the siteRoot
            publicPath = (0, _utils.makePathAbsolute)(process.env.REACT_STATIC_PUBLIC_PATH);

            if (process.env.REACT_STATIC_DISABLE_ROUTE_PREFIXING !== 'true') {
              html = html.replace(hrefReplace, "$1".concat(publicPath, "$3"));
            }

            html = html.replace(srcReplace, "$1".concat(publicPath, "$3")); // If the route is a 404 page, write it directly to 404.html, instead of
            // inside a directory.

            htmlFilename = (0, _utils.is404Path)(route.path) ? _path["default"].join(config.paths.DIST, '404.html') : _path["default"].join(config.paths.DIST, route.path, 'index.html'); // Make the routeInfo sit right next to its companion html file

            routeInfoFilename = _path["default"].join(config.paths.DIST, route.path, 'routeInfo.json');
            _context.next = 77;
            return Promise.all([_fsExtra["default"].outputFile(htmlFilename, html), !route.redirect ? _fsExtra["default"].outputJson(routeInfoFilename, routeInfo) : Promise.resolve()]);

          case 77:
            res = _context.sent;
            return _context.abrupt("return", res);

          case 79:
          case "end":
            return _context.stop();
        }
      }
    }, _callee, null, [[25, 43]]);
  }));

  function exportRoute(_x) {
    return _exportRoute.apply(this, arguments);
  }

  return exportRoute;
}();

exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdGF0aWMvZXhwb3J0Um91dGUuanMiXSwibmFtZXMiOlsiY2FjaGVkQmFzZVBhdGgiLCJjYWNoZWRIcmVmUmVwbGFjZSIsImNhY2hlZFNyY1JlcGxhY2UiLCJnZXRTSEEyNTYiLCJzdHIiLCJoYXNoIiwiY3J5cHRvIiwiY3JlYXRlSGFzaCIsInVwZGF0ZSIsImRpZ2VzdCIsImdldFN1YnJlc291cmNlSGFzaCIsInNoYTI1NiIsImdldEVtYmVkZGVkUm91dGVJbmZvU2NyaXB0IiwiZW1iZWRkZWRSb3V0ZUluZm8iLCJyb3V0ZUluZm9KU09OIiwiSlNPTiIsInN0cmluZ2lmeSIsImlzU2NyaXB0Q29udGV4dCIsIndyYXAiLCJqc29uIiwic2NyaXB0Iiwic3RhdGUiLCJjb25maWciLCJEb2N1bWVudFRlbXBsYXRlIiwicm91dGUiLCJzaXRlRGF0YSIsImNsaWVudFN0YXRzIiwiaW5jcmVtZW50YWwiLCJDb21wIiwic2hhcmVkSGFzaGVzQnlQcm9wIiwidGVtcGxhdGUiLCJkYXRhIiwic2hhcmVkRGF0YSIsInJvdXRlUGF0aCIsInBhdGgiLCJyZW1vdmUiLCJFcnJvciIsInJlbW92ZUxvY2F0aW9uIiwibm9kZVBhdGgiLCJqb2luIiwicGF0aHMiLCJESVNUIiwiZnMiLCJiYXNlUGF0aCIsImhyZWZSZXBsYWNlIiwiUmVnRXhwIiwic3JjUmVwbGFjZSIsInJvdXRlSW5mbyIsImlubGluZVNjcmlwdHMiLCJtZXRhIiwiY2h1bmtOYW1lcyIsImhlYWQiLCJjbGllbnRTY3JpcHRzIiwiY2xpZW50U3R5bGVTaGVldHMiLCJjbGllbnRDc3MiLCJkaXNhYmxlUnVudGltZSIsInJlZGlyZWN0IiwiRmluYWxDb21wIiwicHJvcHMiLCJjaHVua05hbWUiLCJzdGFydHNXaXRoIiwiUk9PVCIsInB1c2giLCJyZW5kZXJUb1N0cmluZ0FuZEV4dHJhY3QiLCJjb21wIiwiYXBwSHRtbCIsIm91dHB1dFBhdGgiLCJzY3JpcHRzIiwic3R5bGVzaGVldHMiLCJjc3MiLCJoZWxtZXQiLCJIZWxtZXQiLCJyZW5kZXJTdGF0aWMiLCJodG1sUHJvcHMiLCJodG1sQXR0cmlidXRlcyIsInRvQ29tcG9uZW50IiwiYm9keVByb3BzIiwiYm9keUF0dHJpYnV0ZXMiLCJiYXNlIiwibGluayIsIm5vc2NyaXB0Iiwic3R5bGUiLCJ0aXRsZSIsInBsdWdpbnMiLCJiZWZvcmVSZW5kZXJUb0VsZW1lbnQiLCJyZW5kZXJUb0VsZW1lbnQiLCJSZW5kZXJlZENvbXAiLCJiZWZvcmVSZW5kZXJUb0h0bWwiLCJyZW5kZXJUb0h0bWwiLCJiZWZvcmVIdG1sVG9Eb2N1bWVudCIsInRoZW4iLCJtZXNzYWdlIiwicmVuZGVyVG9TdGF0aWNNYXJrdXAiLCJfX2h0bWwiLCJEb2N1bWVudEh0bWwiLCJodG1sIiwiYmVmb3JlRG9jdW1lbnRUb0ZpbGUiLCJwdWJsaWNQYXRoIiwicHJvY2VzcyIsImVudiIsIlJFQUNUX1NUQVRJQ19QVUJMSUNfUEFUSCIsIlJFQUNUX1NUQVRJQ19ESVNBQkxFX1JPVVRFX1BSRUZJWElORyIsInJlcGxhY2UiLCJodG1sRmlsZW5hbWUiLCJyb3V0ZUluZm9GaWxlbmFtZSIsIlByb21pc2UiLCJhbGwiLCJvdXRwdXRGaWxlIiwib3V0cHV0SnNvbiIsInJlc29sdmUiLCJyZXMiLCJleHBvcnRSb3V0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOzs7Ozs7QUFFQSxJQUFJQSxjQUFKO0FBQ0EsSUFBSUMsaUJBQUo7QUFDQSxJQUFJQyxnQkFBSjs7QUFFQSxTQUFTQyxTQUFULENBQW1CQyxHQUFuQixFQUF3QjtBQUN0QixNQUFNQyxJQUFJLEdBQUdDLG1CQUFPQyxVQUFQLENBQWtCLFFBQWxCLENBQWI7O0FBQ0FGLEVBQUFBLElBQUksQ0FBQ0csTUFBTCxDQUFZSixHQUFaO0FBQ0EsU0FBT0MsSUFB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T1o7QUFBQTtBQUFBLG1CQXlPSXVFLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLENBQzVCaEUsb0JBQUdpRSxVQUFILENBQWNKLFlBQWQsRUFBNEJSLElBQTVCLENBRDRCLEVBRTVCLENBQUN2RSxLQUFLLENBQUNnQyxRQUFQLEdBQ0lkLG9CQUFHa0UsVUFBSCxDQUFjSixpQkFBZCxFQUFpQ3pELFNBQWpDLENBREosR0FFSTBELE9BQU8sQ0FBQ0ksT0FBUixFQUp3QixDQUFaLENBek9KOztBQUFBO0FBeU9SQyxZQUFBQSxHQXpPUTtBQUFBLDZDQStPUEEsR0EvT087O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsRzs7V0FBZUMsVzs7OztTQUFBQSxXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgeyByZW5kZXJUb1N0cmluZywgcmVuZGVyVG9TdGF0aWNNYXJrdXAgfSBmcm9tICdyZWFjdC1kb20vc2VydmVyJ1xuaW1wb3J0IEhlbG1ldCBmcm9tICdyZWFjdC1oZWxtZXQnXG5pbXBvcnQgeyBSZXBvcnRDaHVua3MgfSBmcm9tICdyZWFjdC11bml2ZXJzYWwtY29tcG9uZW50J1xuaW1wb3J0IGZsdXNoQ2h1bmtzIGZyb20gJ3dlYnBhY2stZmx1c2gtY2h1bmtzJ1xuaW1wb3J0IG5vZGVQYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnXG5pbXBvcnQganNlc2MgZnJvbSAnanNlc2MnXG5cbmltcG9ydCBSZWRpcmVjdCBmcm9tICcuL2NvbXBvbmVudHMvUmVkaXJlY3QnXG5pbXBvcnQgcGx1Z2lucyBmcm9tICcuL3BsdWdpbnMnXG5pbXBvcnQgeyBtYWtlUGF0aEFic29sdXRlLCBpczQwNFBhdGggfSBmcm9tICcuLi91dGlscydcbmltcG9ydCB7IGFic29sdXRlVG9SZWxhdGl2ZUNodW5rTmFtZSB9IGZyb20gJy4uL3V0aWxzL2NodW5rQnVpbGRlcidcblxuaW1wb3J0IG1ha2VIdG1sV2l0aE1ldGEgZnJvbSAnLi9jb21wb25lbnRzL0h0bWxXaXRoTWV0YSdcbmltcG9ydCBtYWtlSGVhZFdpdGhNZXRhIGZyb20gJy4vY29tcG9uZW50cy9IZWFkV2l0aE1ldGEnXG5pbXBvcnQgbWFrZUJvZHlXaXRoTWV0YSBmcm9tICcuL2NvbXBvbmVudHMvQm9keVdpdGhNZXRhJ1xuXG5sZXQgY2FjaGVkQmFzZVBhdGhcbmxldCBjYWNoZWRIcmVmUmVwbGFjZVxubGV0IGNhY2hlZFNyY1JlcGxhY2VcblxuZnVuY3Rpb24gZ2V0U0hBMjU2KHN0cikge1xuICBjb25zdCBoYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTI1NicpXG4gIGhhc2gudXBkYXRlKHN0cilcbiAgcmV0dXJuIGhhc2guZGlnZXN0KCdiYXNlNjQnKVxufVxuXG5mdW5jdGlvbiBnZXRTdWJyZXNvdXJjZUhhc2goc3RyKSB7XG4gIGNvbnN0IHNoYTI1NiA9IGdldFNIQTI1NihzdHIpXG4gIHJldHVybiBgc2hhMjU2LSR7c2hhMjU2fWBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEVtYmVkZGVkUm91dGVJbmZvU2NyaXB0KGVtYmVkZGVkUm91dGVJbmZvKSB7XG4gIGNvbnN0IHJvdXRlSW5mb0pTT04gPSBqc2VzYyhKU09OLnN0cmluZ2lmeShlbWJlZGRlZFJvdXRlSW5mbyksIHtcbiAgICBpc1NjcmlwdENvbnRleHQ6IHRydWUsXG4gICAgd3JhcDogdHJ1ZSxcbiAgICBqc29uOiB0cnVlLFxuICB9KVxuICBjb25zdCBzY3JpcHQgPSBgd2luZG93Ll9fcm91dGVJbmZvID0gSlNPTi5wYXJzZSgke3JvdXRlSW5mb0pTT059KTtgXG4gIGNvbnN0IGhhc2ggPSBnZXRTdWJyZXNvdXJjZUhhc2goc2NyaXB0KVxuXG4gIHJldHVybiB7XG4gICAgaGFzaCxcbiAgICBzY3JpcHQsXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgKGFzeW5jIGZ1bmN0aW9uIGV4cG9ydFJvdXRlKHN0YXRlKSB7XG4gIGNvbnN0IHtcbiAgICBjb25maWcsXG4gICAgRG9jdW1lbnRUZW1wbGF0ZSxcbiAgICByb3V0ZSxcbiAgICBzaXRlRGF0YSxcbiAgICBjbGllbnRTdGF0cyxcbiAgICBpbmNyZW1lbnRhbCxcbiAgfSA9IHN0YXRlXG5cbiAgbGV0IHsgQ29tcCB9ID0gc3RhdGVcblxuICBjb25zdCB7XG4gICAgc2hhcmVkSGFzaGVzQnlQcm9wLFxuICAgIHRlbXBsYXRlLFxuICAgIGRhdGEsXG4gICAgc2hhcmVkRGF0YSxcbiAgICBwYXRoOiByb3V0ZVBhdGgsXG4gICAgcmVtb3ZlLFxuICB9ID0gcm91dGVcblxuICBpZiAoaW5jcmVtZW50YWwgJiYgcmVtb3ZlKSB7XG4gICAgaWYgKGlzNDA0UGF0aChyb3V0ZS5wYXRoKSB8fCByb3V0ZS5wYXRoID09PSAnLycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFlvdSBhcmUgYXR0ZW1wdGluZyB0byBpbmNyZW1lbnRhbGx5IHJlbW92ZSB0aGUgJHtcbiAgICAgICAgICBpczQwNFBhdGgocm91dGUucGF0aCkgPyAnNDA0JyA6ICdpbmRleCdcbiAgICAgICAgfSByb3V0ZSBmcm9tIHlvdXIgZXhwb3J0LiBUaGlzIGlzIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkIChvciByZWNvbW1lbmRlZCkgYnkgUmVhY3QgU3RhdGljLmBcbiAgICAgIClcbiAgICB9XG4gICAgY29uc3QgcmVtb3ZlTG9jYXRpb24gPSBub2RlUGF0aC5qb2luKGNvbmZpZy5wYXRocy5ESVNULCByb3V0ZS5wYXRoKVxuICAgIHJldHVybiBmcy5yZW1vdmUocmVtb3ZlTG9jYXRpb24pXG4gIH1cblxuICBjb25zdCBiYXNlUGF0aCA9IGNhY2hlZEJhc2VQYXRoIHx8IChjYWNoZWRCYXNlUGF0aCA9IGNvbmZpZy5iYXNlUGF0aClcblxuICBjb25zdCBocmVmUmVwbGFjZSA9XG4gICAgY2FjaGVkSHJlZlJlcGxhY2UgfHxcbiAgICAoY2FjaGVkSHJlZlJlcGxhY2UgPSBuZXcgUmVnRXhwKFxuICAgICAgYChocmVmPVtcIiddKVxcXFwvKCR7YmFzZVBhdGggPyBgJHtiYXNlUGF0aH1cXFxcL2AgOiAnJ30pPyhbXlxcXFwvXSlgLFxuICAgICAgJ2dtJ1xuICAgICkpXG5cbiAgY29uc3Qgc3JjUmVwbGFjZSA9XG4gICAgY2FjaGVkU3JjUmVwbGFjZSB8fFxuICAgIChjYWNoZWRTcmNSZXBsYWNlID0gbmV3IFJlZ0V4cChcbiAgICAgIGAoc3JjPVtcIiddKVxcXFwvKCR7YmFzZVBhdGggPyBgJHtiYXNlUGF0aH1cXFxcL2AgOiAnJ30pPyhbXlxcXFwvXSlgLFxuICAgICAgJ2dtJ1xuICAgICkpXG5cbiAgLy8gVGhpcyByb3V0ZUluZm8gd2lsbCBiZSBzYXZlZCB0byBkaXNrLiBJdCBzaG91bGQgb25seSBpbmNsdWRlIHRoZVxuICAvLyBkYXRhIGFuZCBoYXNoZXMgdG8gY29uc3RydWN0IGFsbCBvZiB0aGUgcHJvcHMgbGF0ZXIuXG4gIGNvbnN0IHJvdXRlSW5mbyA9IHtcbiAgICB0ZW1wbGF0ZSxcbiAgICBzaGFyZWRIYXNoZXNCeVByb3AsXG4gICAgZGF0YSxcbiAgICBwYXRoOiByb3V0ZVBhdGgsXG4gIH1cbiAgLy8gVGhpcyBlbWJlZGRlZFJvdXRlSW5mbyB3aWxsIGJlIGlubGluZWQgaW50byB0aGUgSFRNTCBmb3IgdGhpcyByb3V0ZS5cbiAgLy8gSXQgc2hvdWxkIGluY2x1ZGUgYWxsIG9mIHRoZSBkYXRhLCBpbmNsdWRpbmcgc2hhcmVkIGRhdGFcbiAgY29uc3QgZW1iZWRkZWRSb3V0ZUluZm8gPSB7XG4gICAgLi4ucm91dGVJbmZvLFxuICAgIHNoYXJlZERhdGEsXG4gICAgc2l0ZURhdGEsXG4gIH1cblxuICBjb25zdCBpbmxpbmVTY3JpcHRzID0ge1xuICAgIHJvdXRlSW5mbzogZ2V0RW1iZWRkZWRSb3V0ZUluZm9TY3JpcHQoZW1iZWRkZWRSb3V0ZUluZm8pLFxuICB9XG5cbiAgc3RhdGUgPSB7XG4gICAgLi4uc3RhdGUsXG4gICAgcm91dGVJbmZvLFxuICAgIGVtYmVkZGVkUm91dGVJbmZvLFxuICAgIGlubGluZVNjcmlwdHMsXG4gIH1cblxuICAvLyBNYWtlIGEgcGxhY2UgdG8gY29sbGVjdCBjaHVua3MsIG1ldGEgaW5mbyBhbmQgaGVhZCB0YWdzXG4gIGNvbnN0IG1ldGEgPSB7fVxuICBjb25zdCBjaHVua05hbWVzID0gW11cbiAgbGV0IGhlYWQgPSB7fVxuICBsZXQgY2xpZW50U2NyaXB0cyA9IFtdXG4gIGxldCBjbGllbnRTdHlsZVNoZWV0cyA9IFtdXG4gIGxldCBjbGllbnRDc3MgPSB7fVxuXG4gIGxldCBGaW5hbENvbXBcblxuICAvLyBHZXQgdGhlIHJlYWN0IGNvbXBvbmVudCBmcm9tIHRoZSBDb21wIGFuZCBwYXNzIGl0IHRoZSBleHBvcnQgY29udGV4dC4gVGhpc1xuICAvLyB1c2VzIHJlYWN0Q29udGV4dCB1bmRlciB0aGUgaG9vZCB0byBwYXNzIGRvd24gdGhlIGV4cG9ydENvbnRleHQsIHNpbmNlXG4gIC8vIHJlYWN0J3MgbmV3IGNvbnRleHQgYXBpIGRvZXNuJ3Qgc3Vydml2ZSBhY3Jvc3MgYnVuZGxpbmcuXG4gIENvbXAgPSBjb25maWcuZGlzYWJsZVJ1bnRpbWUgPyBDb21wIDogQ29tcChlbWJlZGRlZFJvdXRlSW5mbylcblxuICBpZiAocm91dGUucmVkaXJlY3QpIHtcbiAgICBGaW5hbENvbXAgPSAoKSA9PiA8UmVkaXJlY3QgZnJvbVBhdGg9e3JvdXRlLnBhdGh9IHRvPXtyb3V0ZS5yZWRpcmVjdH0gLz5cbiAgfSBlbHNlIHtcbiAgICBGaW5hbENvbXAgPSBwcm9wcyA9PiAoXG4gICAgICA8UmVwb3J0Q2h1bmtzXG4gICAgICAgIHJlcG9ydD17Y2h1bmtOYW1lID0+IHtcbiAgICAgICAgICAvLyBpZiB3ZSBhcmUgYnVpbGRpbmcgdG8gYSBhYnNvbHV0ZSBwYXRoIHdlIG11c3QgbWFrZSB0aGUgZGV0ZWN0ZWRcbiAgICAgICAgICAvLyBjaHVua05hbWUgcmVsYXRpdmUgYW5kIG1hdGNoaW5nIHRvIHRoZSBvbmUgd2Ugc2V0IGluXG4gICAgICAgICAgLy8gZ2VuZXJhdGVUZW1wbGF0ZXNcbiAgICAgICAgICBpZiAoIWNvbmZpZy5wYXRocy5ESVNULnN0YXJ0c1dpdGgoY29uZmlnLnBhdGhzLlJPT1QpKSB7XG4gICAgICAgICAgICBjaHVua05hbWUgPSBhYnNvbHV0ZVRvUmVsYXRpdmVDaHVua05hbWUoXG4gICAgICAgICAgICAgIGNvbmZpZy5wYXRocy5ST09ULFxuICAgICAgICAgICAgICBjaHVua05hbWVcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjaHVua05hbWVzLnB1c2goY2h1bmtOYW1lKVxuICAgICAgICB9fVxuICAgICAgPlxuICAgICAgICA8Q29tcCB7Li4ucHJvcHN9IC8+XG4gICAgICA8L1JlcG9ydENodW5rcz5cbiAgICApXG4gIH1cblxuICBjb25zdCByZW5kZXJUb1N0cmluZ0FuZEV4dHJhY3QgPSBjb21wID0+IHtcbiAgICAvLyBSZW5kIHRoZSBhcHAgdG8gc3RyaW5nIVxuICAgIGNvbnN0IGFwcEh0bWwgPSByZW5kZXJUb1N0cmluZyhjb21wKVxuICAgIGNvbnN0IHsgc2NyaXB0cywgc3R5bGVzaGVldHMsIGNzcyB9ID0gZmx1c2hDaHVua3MoY2xpZW50U3RhdHMsIHtcbiAgICAgIGNodW5rTmFtZXMsXG4gICAgICBvdXRwdXRQYXRoOiBjb25maWcucGF0aHMuRElTVCxcbiAgICB9KVxuXG4gICAgY2xpZW50U2NyaXB0cyA9IHNjcmlwdHNcbiAgICBjbGllbnRTdHlsZVNoZWV0cyA9IHN0eWxlc2hlZXRzXG4gICAgY2xpZW50Q3NzID0gY3NzXG4gICAgLy8gRXh0cmFjdCBoZWFkIGNhbGxzIHVzaW5nIEhlbG1ldCBzeW5jaHJvbm91c2x5IHJpZ2h0IGFmdGVyIHJlbmRlclRvU3RyaW5nXG4gICAgLy8gdG8gbm90IGludHJvZHVjZSBhbnkgcmFjZSBjb25kaXRpb25zIGluIHRoZSBtZXRhIGRhdGEgcmVuZGVyaW5nXG4gICAgY29uc3QgaGVsbWV0ID0gSGVsbWV0LnJlbmRlclN0YXRpYygpXG4gICAgaGVhZCA9IHtcbiAgICAgIGh0bWxQcm9wczogaGVsbWV0Lmh0bWxBdHRyaWJ1dGVzLnRvQ29tcG9uZW50KCksXG4gICAgICBib2R5UHJvcHM6IGhlbG1ldC5ib2R5QXR0cmlidXRlcy50b0NvbXBvbmVudCgpLFxuICAgICAgYmFzZTogaGVsbWV0LmJhc2UudG9Db21wb25lbnQoKSxcbiAgICAgIGxpbms6IGhlbG1ldC5saW5rLnRvQ29tcG9uZW50KCksXG4gICAgICBtZXRhOiBoZWxtZXQubWV0YS50b0NvbXBvbmVudCgpLFxuICAgICAgbm9zY3JpcHQ6IGhlbG1ldC5ub3NjcmlwdC50b0NvbXBvbmVudCgpLFxuICAgICAgc2NyaXB0OiBoZWxtZXQuc2NyaXB0LnRvQ29tcG9uZW50KCksXG4gICAgICBzdHlsZTogaGVsbWV0LnN0eWxlLnRvQ29tcG9uZW50KCksXG4gICAgICB0aXRsZTogaGVsbWV0LnRpdGxlLnRvQ29tcG9uZW50KCksXG4gICAgfVxuXG4gICAgcmV0dXJuIGFwcEh0bWxcbiAgfVxuXG4gIGxldCBhcHBIdG1sXG5cbiAgc3RhdGUgPSB7XG4gICAgLi4uc3RhdGUsXG4gICAgbWV0YSxcbiAgfVxuXG4gIHRyeSB7XG4gICAgRmluYWxDb21wID0gYXdhaXQgcGx1Z2lucy5iZWZvcmVSZW5kZXJUb0VsZW1lbnQoRmluYWxDb21wLCBzdGF0ZSlcblxuICAgIGlmIChjb25maWcucmVuZGVyVG9FbGVtZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBjb25maWcucmVuZGVyVG9FbGVtZW50IGhhcyBiZWVuIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgdGhlIGAgK1xuICAgICAgICAgIGAnYmVmb3JlUmVuZGVyVG9FbGVtZW50JyBvciAnYmVmb3JlUmVuZGVyVG9IdG1sJyBob29rcyBpbnN0ZWFkLmBcbiAgICAgIClcbiAgICB9XG5cbiAgICBsZXQgUmVuZGVyZWRDb21wID0gPEZpbmFsQ29tcCAvPlxuXG4gICAgLy8gUnVuIHRoZSBiZWZvcmVSZW5kZXJUb0h0bWwgaG9va1xuICAgIC8vIFJ1bSB0aGUgSHRtbCBob29rXG4gICAgUmVuZGVyZWRDb21wID0gYXdhaXQgcGx1Z2lucy5iZWZvcmVSZW5kZXJUb0h0bWwoUmVuZGVyZWRDb21wLCBzdGF0ZSlcblxuICAgIGlmIChjb25maWcucmVuZGVyVG9IdG1sKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBjb25maWcucmVuZGVyVG9IdG1sIGhhcyBiZWVuIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgdGhlIGAgK1xuICAgICAgICAgIGAnYmVmb3JlUmVuZGVyVG9IdG1sJyBvciAnYmVmb3JlSHRtbFRvRG9jdW1lbnQnIGhvb2tzIGluc3RlYWQuYFxuICAgICAgKVxuICAgIH1cblxuICAgIGFwcEh0bWwgPSByZW5kZXJUb1N0cmluZ0FuZEV4dHJhY3QoUmVuZGVyZWRDb21wKVxuXG4gICAgYXBwSHRtbCA9IGF3YWl0IHBsdWdpbnMuYmVmb3JlSHRtbFRvRG9jdW1lbnQoYXBwSHRtbCwgc3RhdGUpXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yLnRoZW4pIHtcbiAgICAgIGVycm9yLm1lc3NhZ2UgPVxuICAgICAgICAnQ29tcG9uZW50cyBhcmUgbm90IGFsbG93ZWQgdG8gc3VzcGVuZCBkdXJpbmcgc3RhdGljIGV4cG9ydC4gUGxlYXNlICcgK1xuICAgICAgICAnbWFrZSBpdHMgZGF0YSBhdmFpbGFibGUgc3luY2hyb25vdXNseSBhbmQgdHJ5IGFnYWluISdcbiAgICB9XG4gICAgZXJyb3IubWVzc2FnZSA9IGBGYWlsZWQgZXhwb3J0aW5nIEhUTUwgZm9yIFVSTCAke3JvdXRlLnBhdGh9ICgke3JvdXRlLnRlbXBsYXRlfSk6ICR7ZXJyb3IubWVzc2FnZX1gXG4gICAgdGhyb3cgZXJyb3JcbiAgfVxuXG4gIHN0YXRlID0ge1xuICAgIC4uLnN0YXRlLFxuICAgIGhlYWQsXG4gICAgY2xpZW50U2NyaXB0cyxcbiAgICBjbGllbnRTdHlsZVNoZWV0cyxcbiAgICBjbGllbnRDc3MsXG4gIH1cblxuICBjb25zdCBEb2N1bWVudEh0bWwgPSByZW5kZXJUb1N0YXRpY01hcmt1cChcbiAgICA8RG9jdW1lbnRUZW1wbGF0ZVxuICAgICAgSHRtbD17YXdhaXQgbWFrZUh0bWxXaXRoTWV0YShzdGF0ZSl9XG4gICAgICBIZWFkPXthd2FpdCBtYWtlSGVhZFdpdGhNZXRhKHN0YXRlKX1cbiAgICAgIEJvZHk9e2F3YWl0IG1ha2VCb2R5V2l0aE1ldGEoc3RhdGUpfVxuICAgICAgc3RhdGU9e3N0YXRlfVxuICAgID5cbiAgICAgIDxkaXYgaWQ9XCJyb290XCIgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUw9e3sgX19odG1sOiBhcHBIdG1sIH19IC8+XG4gICAgPC9Eb2N1bWVudFRlbXBsYXRlPlxuICApXG5cbiAgLy8gUmVuZGVyIHRoZSBodG1sIGZvciB0aGUgcGFnZSBpbnNpZGUgb2YgdGhlIGJhc2UgZG9jdW1lbnQuXG4gIGxldCBodG1sID0gYDwhRE9DVFlQRSBodG1sPiR7RG9jdW1lbnRIdG1sfWBcblxuICBodG1sID0gYXdhaXQgcGx1Z2lucy5iZWZvcmVEb2N1bWVudFRvRmlsZShodG1sLCBzdGF0ZSlcblxuICAvLyBJZiB0aGUgc2l0ZVJvb3QgaXMgc2V0IGFuZCB3ZSdyZSBub3QgaW4gc3RhZ2luZywgcHJlZml4IGFsbCBhYnNvbHV0ZSBVUkxzXG4gIC8vIHdpdGggdGhlIHNpdGVSb290XG4gIGNvbnN0IHB1YmxpY1BhdGggPSBtYWtlUGF0aEFic29sdXRlKHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19QVUJMSUNfUEFUSClcbiAgaWYgKHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19ESVNBQkxFX1JPVVRFX1BSRUZJWElORyAhPT0gJ3RydWUnKSB7XG4gICAgaHRtbCA9IGh0bWwucmVwbGFjZShocmVmUmVwbGFjZSwgYCQxJHtwdWJsaWNQYXRofSQzYClcbiAgfVxuXG4gIGh0bWwgPSBodG1sLnJlcGxhY2Uoc3JjUmVwbGFjZSwgYCQxJHtwdWJsaWNQYXRofSQzYClcblxuICAvLyBJZiB0aGUgcm91dGUgaXMgYSA0MDQgcGFnZSwgd3JpdGUgaXQgZGlyZWN0bHkgdG8gNDA0Lmh0bWwsIGluc3RlYWQgb2ZcbiAgLy8gaW5zaWRlIGEgZGlyZWN0b3J5LlxuICBjb25zdCBodG1sRmlsZW5hbWUgPSBpczQwNFBhdGgocm91dGUucGF0aClcbiAgICA/IG5vZGVQYXRoLmpvaW4oY29uZmlnLnBhdGhzLkRJU1QsICc0MDQuaHRtbCcpXG4gICAgOiBub2RlUGF0aC5qb2luKGNvbmZpZy5wYXRocy5ESVNULCByb3V0ZS5wYXRoLCAnaW5kZXguaHRtbCcpXG5cbiAgLy8gTWFrZSB0aGUgcm91dGVJbmZvIHNpdCByaWdodCBuZXh0IHRvIGl0cyBjb21wYW5pb24gaHRtbCBmaWxlXG4gIGNvbnN0IHJvdXRlSW5mb0ZpbGVuYW1lID0gbm9kZVBhdGguam9pbihcbiAgICBjb25maWcucGF0aHMuRElTVCxcbiAgICByb3V0ZS5wYXRoLFxuICAgICdyb3V0ZUluZm8uanNvbidcbiAgKVxuXG4gIGNvbnN0IHJlcyA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICBmcy5vdXRwdXRGaWxlKGh0bWxGaWxlbmFtZSwgaHRtbCksXG4gICAgIXJvdXRlLnJlZGlyZWN0XG4gICAgICA/IGZzLm91dHB1dEpzb24ocm91dGVJbmZvRmlsZW5hbWUsIHJvdXRlSW5mbylcbiAgICAgIDogUHJvbWlzZS5yZXNvbHZlKCksXG4gIF0pXG4gIHJldHVybiByZXNcbn0pXG4iXX0=